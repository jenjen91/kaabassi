<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script>
    // This is highly simplified and needs robust error handling and token management.
    // You will need to get AUTH0_DOMAIN and AUTH0_CLIENT_ID from Netlify's environment variables
    // (e.g., through a build-time script or by hardcoding for now, NOT RECOMMENDED).

    import Auth0Client from '@auth0/auth0-spa-js';

    async function initializeAuth0() {
    const auth0 = await Auth0Client.createAuth0Client({
      domain: process.env.AUTH0_DOMAIN, // Get this from Netlify ENV vars during build
      clientId: process.env.AUTH0_CLIENT_ID, // Get this from Netlify ENV vars during build
      redirect_uri: window.location.origin + '/admin/', // Or your specific callback URL
      cacheLocation: 'localstorage',
    });

    // Check if redirected from Auth0
    if (window.location.search.includes('code=') || window.location.search.includes('state=')) {
      await auth0.handleRedirectCallback();
      window.history.replaceState({}, document.title, window.location.pathname + window.location.hash);
    }

    // Login function
    window.authenticate = async () => {
      await auth0.loginWithRedirect();
    };

    // Get user and token for Netlify CMS
    window.CMS_CONFIG.setAuth({
      authenticate: async () => {
        if (!await auth0.isAuthenticated()) {
          await window.authenticate(); // Redirect to login
        }
        const user = await auth0.getUser();
        const idToken = await auth0.getIdTokenClaims();
        return {
          token: idToken.__raw, // The JWT to pass to CMS
          email: user.email,
          name: user.name,
        };
      },
      logout: async () => {
        await auth0.logout({
          logoutParams: {
            returnTo: window.location.origin + '/admin/',
          },
        });
      },
    });

    // If already authenticated, show CMS
    if (await auth0.isAuthenticated()) {
      CMS.init({ config: window.CMS_CONFIG });
    } else {
      // If not authenticated, prompt login
      window.authenticate();
    }
    }

    // Call this after CMS.init is available, possibly after an initial CMS.init()
    // with a basic config and then overriding the auth method.
    // This is where Netlify CMS's custom auth provider documentation becomes key.
    // See: https://decapcms.org/docs/authentication/#custom-authentication-providers
  </script>
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
</body>
</html>
